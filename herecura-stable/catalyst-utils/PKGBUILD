# Maintainer: Vi0L0 <vi0l093@gmail.com>
# Great Contributor: Eduardo "kensai" Romero (previous maintainer)

pkgname=catalyst-utils
pkgver=11.1
pkgrel=1
pkgdesc="AMD/ATI Catalyst drivers utilities and libraries."
arch=('i686' 'x86_64')
url="http://www.ati.amd.com"
license=('custom')
depends=('xorg-server>=1.9.0' 'xorg-server<1.10.0' 'netkit-bsd-finger' 'libxrandr' 'libsm' 'fontconfig' 'libxcursor' 'libxi' 'gcc-libs')
optdepends=('qt: to run ATi Catalyst Control Center (amdcccle)')
replaces=('libgl')
conflicts=('catalyst-test' 'nvidia-utils' 'libgl')
provides=('libgl' "libatical=${pkgver}")
install=${pkgname}.install


source=(
	http://www2.ati.com/drivers/linux/ati-driver-installer-${pkgver/./-}-x86.x86_64.run
	catalyst.sh
	amdcccle.desktop
	atieventsd.sh
)
sha256sums=(
	'0c0cb9e2d85fa649162dec3680c1a22bbfb9e82719fba2b0d9445135284307f1'
	'd5583bfb5977f73b4ca65533030f490350daca9e0ed10aefe517ffb70817531e'
	'48450ae34d4594f6f90c7d3e170ece4216165252180393dda40982d90821ee36'
	'32f12a15d1c3289b3c45aff8ca6998fa265f53a96a9c73b36d7c83ec0e0f8ce8'
)

build() {
	## Unpack archive
	/bin/sh ./ati-driver-installer-${pkgver/./-}-x86.x86_64.run --extract archive_files
}

package() {
	## Install userspace tools and libraries
	# Create directories
	install -m755 -d "${pkgdir}/etc/ati"
	install -m755 -d "${pkgdir}/etc/rc.d"
	install -m755 -d "${pkgdir}/etc/profile.d"
	install -m755 -d "${pkgdir}/etc/acpi/events"
	install -m755 -d "${pkgdir}/etc/security/console.apps"

	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/dri"
	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/drivers"
	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/linux"
	install -m755 -d "${pkgdir}/usr/lib/dri"

	install -m755 -d "${pkgdir}/usr/bin"
	install -m755 -d "${pkgdir}/usr/sbin"

	install -m755 -d "${pkgdir}/usr/include/X11/extensions"
	install -m755 -d "${pkgdir}/usr/include/GL"

	install -m755 -d "${pkgdir}/usr/share/applications"
	install -m755 -d "${pkgdir}/usr/share/ati/amdcccle"
	install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
	install -m755 -d "${pkgdir}/usr/share/man/man8"
	install -m755 -d "${pkgdir}/usr/share/pixmaps"

	# X.org driver
	if [ "${CARCH}" = "i686" ]; then
		cd "${srcdir}/archive_files/x760/usr/X11R6/lib/modules"
	elif [ "${CARCH}" = "x86_64" ]; then
		cd "${srcdir}/archive_files/x760_64a/usr/X11R6/lib64/modules"
	fi

	#install -m644 *.a "${pkgdir}/usr/lib/xorg/modules/"
	install -m755 *.so "${pkgdir}/usr/lib/xorg/modules/"
	install -m755 drivers/*.so "${pkgdir}/usr/lib/xorg/modules/drivers/"
	install -m755 linux/*.so "${pkgdir}/usr/lib/xorg/modules/linux/"
	install -m755 extensions/libglx.so "${pkgdir}/usr/lib/xorg/modules/extensions/"
	#install -m755 extensions/libdri.so "${pkgdir}/usr/lib/xorg/modules/extensions/libdri.ati"

	# Controlcenter / libraries
	if [ "${CARCH}" = "i686" ]; then
		cd "${srcdir}/archive_files/arch/x86/usr"
		_lib=lib
	elif [ "${CARCH}" = "x86_64" ]; then
		cd "${srcdir}/archive_files/arch/x86_64/usr"
		_lib=lib64
	fi

	install -m755 X11R6/bin/* "${pkgdir}/usr/bin/"
	install -m755 sbin/* "${pkgdir}/usr/sbin/"
	install -m755 X11R6/${_lib}/*.so* "${pkgdir}/usr/lib/"
	install -m644 X11R6/${_lib}/*.a "${pkgdir}/usr/lib/" # really needed?
	install -m644 X11R6/${_lib}/*.cap "${pkgdir}/usr/lib/"
	install -m755 X11R6/${_lib}/modules/dri/*.so "${pkgdir}/usr/lib/xorg/modules/dri/"
	install -m755 ${_lib}/*.so* "${pkgdir}/usr/lib/"

	## QT libs (only 2 files) - un-comment 2 lines below if you don't want to install qt package
	#      install -m755 -d "${pkgdir}/usr/share/ati/${_lib}"
	#      install -m755 share/ati/${_lib}/*.so* "${pkgdir}/usr/share/ati/${_lib}/"

	ln -sf /usr/lib/xorg/modules/dri/fglrx_dri.so ${pkgdir}/usr/lib/dri/fglrx_dri.so
	ln -sf libfglrx_dm.so.1.0 "${pkgdir}/usr/lib/libfglrx_dm.so.1"
	ln -sf libfglrx_dm.so.1.0 "${pkgdir}/usr/lib/libfglrx_dm.so"
	#ln -sf libfglrx_pp.so.1.0 "${pkgdir}/usr/lib/libfglrx_pp.so.1"
	#ln -sf libfglrx_tvout.so.1.0 "${pkgdir}/usr/lib/libfglrx_tvout.so.1"
	ln -sf libfglrx_gamma.so.1.0 "${pkgdir}/usr/lib/libfglrx_gamma.so.1"
	ln -sf libGL.so.1.2 "${pkgdir}/usr/lib/libGL.so.1"
	ln -sf libGL.so.1.2 "${pkgdir}/usr/lib/libGL.so"
	ln -sf libatiuki.so.1.0 "${pkgdir}/usr/lib/libatiuki.so.1"
	ln -sf libatiuki.so.1.0 "${pkgdir}/usr/lib/libatiuki.so"


	cd "${srcdir}"/archive_files/common
	install -m644 etc/ati/* "${pkgdir}/etc/ati/"
	chmod 755 "${pkgdir}/etc/ati/authatieventsd.sh"

	#security provided with 10.9, is it working fine?
	install -m644 etc/security/console.apps/amdcccle-su "${pkgdir}/etc/security/console.apps/"

	install -m644 usr/X11R6/include/X11/extensions/*.h "${pkgdir}/usr/include/X11/extensions/"
	install -m644 usr/X11R6/bin/amdupdaterandrconfig "${pkgdir}/usr/bin/"
	install -m644 usr/include/GL/*.h "${pkgdir}/usr/include/GL/"
	install -m755 usr/sbin/*.sh "${pkgdir}/usr/sbin/"
	install -m644 usr/share/ati/amdcccle/* "${pkgdir}/usr/share/ati/amdcccle/" # ? what are these files for?
	# install -m644 usr/share/gnome/apps/amdcccle.desktop "${pkgdir}/usr/share/applications/"
	install -m644 usr/share/icons/*.xpm "${pkgdir}/usr/share/pixmaps/"
	install -m644 usr/share/man/man8/*.8 "${pkgdir}/usr/share/man/man8/"
	install -m644 "${srcdir}/amdcccle.desktop" "${pkgdir}/usr/share/applications/"

	# ACPI example files
	install -m755 usr/share/doc/fglrx/examples/etc/acpi/*.sh "${pkgdir}/etc/acpi/"
	sed -i -e 's/usr\/X11R6/usr/g' "${pkgdir}/etc/acpi/ati-powermode.sh"
	install -m644 usr/share/doc/fglrx/examples/etc/acpi/events/* "${pkgdir}/etc/acpi/events/"

	# Add ATI Events Daemon launcher
	install -m755 "${srcdir}/atieventsd.sh" "${pkgdir}/etc/rc.d/atieventsd"

	# thanks to cerebral, we dont need that damned symlink
	install -m755 "${srcdir}/catalyst.sh" "${pkgdir}/etc/profile.d/"

	# License
	install -m644 "${srcdir}/archive_files/ATI_LICENSE.TXT" "${pkgdir}/usr/share/licenses/${pkgname}/"
}
