# vim:set ft=sh:
#Maintainer: David Lehmann <dtl@voxelbrain.com>
#Contributor: Sebastian Friedel <sef@voxelbrain.com>
#Contributor: Mathias Stearn <mathias@10gen.com>
pkgname=mongodb-git
_gitname="mongo"
pkgver=20130807.8302c67
pkgrel=1
pkgdesc="A high-performance, open source, schema-free document-oriented database."
arch=('i686' 'x86_64')
url="http://www.mongodb.org"
license=('AGPL')
makedepends=('git' 'scons' 'boost')
depends=('boost-libs' 'v8' 'pcre')
provides=('mongodb')
conflicts=('mongodb')
install=${pkgname}.install
backup=('etc/mongodb.conf')
source=(
	"$_gitname::git://github.com/mongodb/mongo.git"
	'mongodb.rc'
	'mongodb.conf'
)
sha256sums=(
	'SKIP'
	'5ba40a3c2d1c67f7617f010e660e2a0c609dcf5c5e7c897d7ac6843167d8329f'
	'f3fc037c704d67c68c7d69c46878af3d8a601e48ca51105835f740cddb1b2b2e'
)

pkgver() {
	cd "$srcdir/$_gitname"
	echo $(git log -1 --format="%ci" | sed 's/.*\([0-9]\{4\}\)-\([0-9]\{2\}\)-\([0-9]\{2\}\).*/\1\2\3/').$(git rev-parse --short HEAD)
}

build() {
	cd ${_gitname}

	#sed -i 's|lib64|lib|g' SConstruct
	#sed -i '/-Werror/d' SConstruct

	export SCONSFLAGS="${MAKEFLAGS}"
	scons all --usev8 --full
}

package() {
	cd ${_gitname}
	scons install --usev8 --full --prefix="${startdir}/pkg/usr"
	#scons install --prefix="${startdir}/pkg/usr"
	install -D -m755 "${startdir}/mongodb.rc" "${startdir}/pkg/etc/rc.d/mongodb"
	install -D -m644 "${startdir}/mongodb.conf" "${startdir}/pkg/etc/mongodb.conf"
	install -d -m700 "${startdir}/pkg/var/lib/mongodb"
}
